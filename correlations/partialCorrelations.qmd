---
title: "Partial Correlations"
format: 
  html:
    code-fold: true
editor: visual
---

As you may have heard, correlation does not equal causation. One possible reason for this is that there's a third variable that explains an association. Let's imagine that we are trying to understand whether life expectancy goes up over time and why. First of all, let's check if lifeExpectancy is going up over time using the **gapminder** data:

::: panel-tabset
## R

```{r}
library(gapminder)
library(ggplot2)
library(tidyverse)

gapminder %>% 
  group_by(year) %>% 
  summarise(
    lifeExp = mean(lifeExp),
    gdpPercap = mean(gdpPercap)
  ) -> gapminder_by_year

cor.test(gapminder_by_year$year, gapminder_by_year$lifeExp)
ggplot(data = gapminder_by_year, aes(x = year, y = lifeExp)) + geom_point() + geom_smooth(method = lm)
```

## Python

```{python}
#| eval: false

# TBC

```

## Julia

```{julia}
#| eval: false

# TBC

```
:::

So now that we've confirmed that there is a positive association between the year and life expectancy, the next question is why? What changes from year to year that could explain increased life expectancy? Let's investigate whether gdp per capita generally goes up each year, and whether it's associated with life expectancy. If both of these things are true, then perhaps the increase in gdp per year is an explanation of the association between year and life expectancy.

### Is year and gdp per capita associated?

::: panel-tabset
## R

```{r}
cor.test(gapminder_by_year$year, gapminder_by_year$gdpPercap)
ggplot(data = gapminder_by_year, aes(x = year, y = gdpPercap)) + geom_point() + geom_smooth(method = lm)
```

Whilst there are some outliers in earlier years, we seem to have found that gdp per capita has gone up.
:::

### Is gdp per capita and life expectancy associated?

::: panel-tabset
## R

```{r}
cor.test(gapminder_by_year$gdpPercap, gapminder_by_year$lifeExp)
ggplot(data = gapminder_by_year, aes(x = gdpPercap, y = lifeExp)) + geom_point() + geom_smooth(method = lm)
```
:::

So the above analysis suggests that all three variables are **incredibly** related. (you are unlikely to see such strong associations in real psychology experiments). But let's now check in whether there's still an association between the year and life expectancy once you control for GDP per capita. This partial correlation can be visualised as follows:

```{mermaid}
flowchart LR
    Year(X:Year) <---> GDP(Z:GDP per Capita)
    Year <---> Life(Y:Life Expectancy)
    GDP <---> Life 
  style Year color:white,fill:#159,stroke:#333,stroke-width:4px
  style Life color:white,fill:#159,stroke:#333,stroke-width:4px
  style GDP fill:#571,stroke:#fff,stroke-width:3px,color:#fff,stroke-dasharray: 5 5
```

To calculate the partial correlation r value you control for the association between the two variables

$$
r_{xy*z} = \frac{r_{xy} - r_{xz} * r_{yz}}{\sqrt{(1-r^2_{xz})(1-r^2_{yz})}} = \frac{originalCorrelation - varianceExplainedByCovariate}{varianceNotExplainedByCovariate}
$$

- $x$ = The Year
- $y$ = Life expectancy
- $z$ = GDP per capita 
- $\sqrt{1- r^2_{xz}}$ = variance not explained by correlation between Year($x$) and GDP ($z$)
- $\sqrt{1- r^2_{yz}}$ = variance not explained by correlation between Life Expectancy ($y$) and GDP ($z$)

One way to think of the formula above is that:
- the top-half represents how much variance is explained by overlap between the two main variables, subtracted by the variance of each variable with the confound
- the bottom-half represents how much variance there is left to explain once you've removed associations between each main variable and the covariate.

Let's see what the r value is after this partial correlation:


$$
r_{xy*z} = \frac{r_{xy} - r_{xz} * r_{yz}}{\sqrt{(1-r^2_{xz})(1-r^2_{yz})}} = \frac{.986158 - .9832101 * .9619721 }{\sqrt{(1-.9832101^2)(1-.9619721^2)}} = \frac{.040354}{.04984321} = .8092841
$$

Let's check if the manually calculated partial r-value is the same as what R gives us:


```{r}
library(ppcor)
pcor(gapminder_by_year)
```
Yes, the pearson correlation between year and life expectancy is .8092844, so the difference of .0000003 is a rounding error from the manual calculations above. Just to confirm that this is a rounding error, here's what you get if you complete the same steps but with the estimate part of the correlation objects instead:

```{r}
x.y.cor <- cor.test(gapminder_by_year$year, gapminder_by_year$lifeExp)
x.z.cor <- cor.test(gapminder_by_year$year, gapminder_by_year$gdpPercap)
y.z.cor <- cor.test(gapminder_by_year$gdpPercap, gapminder_by_year$lifeExp)

(x.y.cor$estimate - x.z.cor$estimate * y.z.cor$estimate)/sqrt((1-x.z.cor$estimate^2) * (1 - y.z.cor$estimate^2))
```

Confirming that the difference in the manual calculation is a rounding error. Note that the numbers you get from R may be rounded numbers, and so your calculations may reflect the rounding.
